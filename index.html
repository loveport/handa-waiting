<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HANDA ë¶€ìŠ¤ ëŒ€ê¸° ì‹œìŠ¤í…œ</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #eef2f5; }
    .box { max-width: 400px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px #ccc; text-align: center; }
    h2 { margin-bottom: 20px; }
    button { padding: 10px 20px; font-size: 16px; border: none; border-radius: 5px; background: #007BFF; color: white; cursor: pointer; margin: 10px 0; }
    .cancel-btn { background: #dc3545; }
    #status { margin-top: 20px; font-size: 18px; color: #333; }
    #alertBox { margin-top: 20px; background: #fffbcc; padding: 15px; border-radius: 8px; border: 1px solid #f0e68c; }
  </style>
</head>
<body>
  <div class="box">
    <h2>HANDA ë¶€ìŠ¤ ëŒ€ê¸° ì‹œìŠ¤í…œ</h2>
    <button id="registerBtn" onclick="registerQueue()">ëŒ€ê¸° ë“±ë¡í•˜ê¸°</button>
    <button id="cancelBtn" class="cancel-btn" onclick="cancelQueue()" style="display:none;">ëŒ€ê¸° ì·¨ì†Œ</button>

    <div id="status"></div>

    <div id="alertBox" style="display:none;">
      <strong>ğŸ”” í˜¸ì¶œë˜ì—ˆìŠµë‹ˆë‹¤!</strong>
      <p>ë¶€ìŠ¤ë¡œ ì´ë™í•´ ì£¼ì„¸ìš”.</p>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCd7VZ-Ihr-BKaZB3zGioJFOXE5kDSG9o4",
      authDomain: "handawaiting-fa63c.firebaseapp.com",
      databaseURL: "https://handawaiting-fa63c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "handawaiting-fa63c",
      storageBucket: "handawaiting-fa63c.appspot.com",
      messagingSenderId: "799592766063",
      appId: "1:799592766063:web:aa55ba86ddb04d3f7a4b9a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let userKey = localStorage.getItem("userKey");

    function registerQueue() {
      if (userKey) {
        alert("ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
        return;
      }

      const timestamp = Date.now();
      const newRef = db.ref("waitingQueue").push();
      newRef.set(timestamp);
      userKey = newRef.key;
      localStorage.setItem("userKey", userKey);

      document.getElementById("status").innerText = "ëŒ€ê¸°ì—´ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.";
      document.getElementById("cancelBtn").style.display = "inline-block";

      checkCalledStatus();
    }

    function cancelQueue() {
      if (!userKey) return;

      if (confirm("ì •ë§ë¡œ ëŒ€ê¸°ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        db.ref("waitingQueue/" + userKey).remove();
        db.ref("calledList/" + userKey).remove();
        localStorage.removeItem("userKey");
        userKey = null;

        document.getElementById("status").innerText = "ëŒ€ê¸° ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.";
        document.getElementById("cancelBtn").style.display = "none";
        document.getElementById("alertBox").style.display = "none";
      }
    }

    function checkCalledStatus() {
      if (!userKey) return;

      db.ref("calledList/" + userKey).on("value", snapshot => {
        const isCalled = snapshot.exists();

        if (isCalled) {
          document.getElementById("alertBox").style.display = "block";
        } else {
          document.getElementById("alertBox").style.display = "none";
        }
      });
    }

    window.onload = function () {
      if (userKey) {
        document.getElementById("status").innerText = "ì´ë¯¸ ëŒ€ê¸°ì—´ì— ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.";
        document.getElementById("cancelBtn").style.display = "inline-block";
        checkCalledStatus();
      }
    };
  </script>
</body>
</html>
